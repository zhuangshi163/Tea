KISSY.add("gallery/image-tagging/1.0/image-tagging",function(d,p){function f(e,b,h){f.Config.dynamic&&!i.used&&(i.used=!0,i.on("globalInterval",q),w.on(window,"resize",q));var g={};d.mix(g,h);g.picNode=a.get(e);e=g.picNode;g.coords=b;this.tagNodes=[];this.wrapNode=null;e&&b&&((r||(r=a.create('<div class="ks-tagging-container"></div>'),a.addStyleSheet(".ks-tagging-container {position:absolute;top:0;left:0;}"),a.append(r,a.get("body")),a.addStyleSheet(".ks-tag-wrap {position:absolute;}")),i.timer||
(i.timer=d.later(function(){i.fire("globalInterval")},this.constructor.Config.timerInterval,!0)),e.complete)?(d.log("Render Run"),this._renderPic(g)):(k.push([g,this]),o||(i.on("globalInterval",s),o=1)))}var a=d.DOM,w=d.Event,r=null,i={timer:null,used:!1},o=0,k=[],v=[],x=0;d.mix(i,d.EventTarget);var s=function(){for(var a=0;a<k.length;a++)k[a][0].picNode.complete&&(k[a][1]._renderPic(k[a][0]),k.splice(a,1));0===k.length&&(i.detach("globalInterval",s),o=0)},q=function(){d.log("process Run");d.each(v,
function(e){var b=e.img,e=e.wrapNode,d=parseInt(a.css(b,"paddingTop"),10),g=parseInt(a.css(b,"paddingLeft"),10),c=parseInt(a.css(b,"borderTopWidth"),10),f=parseInt(a.css(b,"borderLeftWidth"),10),b=a.offset(b);a.css(e,{top:b.top+d+c,left:b.left+g+f})})};f.Config=d.mix({},{dynamic:!0,timerInterval:250,rules:{container:"",imageClass:"",imageIgnoreClass:"",minWidth:400,minHeight:400,ratio:0.5}});d.augment(f,d.EventTarget,{_renderPic:function(e){var b=e.picNode,h=e.coords,g=a.width(b),c=a.height(b);if(!(g<
f.Config.rules.minWidth||c<f.Config.rules.minHeight||f.Config.rules.imageIgnoreClass&&a.hasClass(b,f.Config.rules.imageIgnoreClass)||f.Config.rules.imageClass&&!a.hasClass(b,f.Config.rules.imageClass)||f.Config.rules.ratio&&Math.min(g/c,c/g)<f.Config.rules.ratio)){var g=parseInt(a.css(b,"paddingTop"),10),i=parseInt(a.css(b,"paddingLeft"),10),k=parseInt(a.css(b,"borderTopWidth"),10),o=parseInt(a.css(b,"borderLeftWidth"),10),j=a.offset(b),q=j.top,s=j.left,j=a.create('<div class="ks-tag-wrap"></div>'),
t=a.create('<div class="ks-tag-btnwrap"></div>'),u=e.tagClass?e.tagClass:"ks-tag",e=e.tagContent?e.tagContent:"",l="",m="",n=null;a.addClass(j,"ks-tagindex-"+x++);a.css(j,{top:q+g+k,left:s+i+o});a.css(t,{position:"absolute",top:c,left:0});a.append(t,j);a.append(j,r);for(c=0;c<h.length;c++)d.isFunction(e)?(l=e({index:c}),!l&&(l="")):l=e,d.isFunction(u)?(m=u({index:c}),!m&&(m="")):m=u,n=a.create('<div class="'+m+'" tagindex="'+c+'">'+l+"</div>"),d.isNumber(h[c].bottom)&&!isNaN(h[c].bottom)?(a.append(n,
t),a.css(n,{position:"absolute",bottom:h[c].bottom,left:h[c].left}),overlayNode=new p({srcNode:n,elCls:m,content:l,align:{node:t,points:["bl","bl"],offset:[h[c].left,h[c].bottom]}})):(a.append(n,j),a.css(n,{position:"absolute",top:h[c].top,left:h[c].left}),overlayNode=new p({srcNode:n,elCls:m,content:l,align:{node:j,points:["tl","tl"],offset:[h[c].left,h[c].top]}})),overlayNode.render(),overlayNode.show(),this.tagNodes.push(overlayNode);this.wrapNode=j;v.push({img:b,wrapNode:j})}},showAll:function(){d.each(this.tagNodes,
function(a){a.show()})},hideAll:function(){d.each(this.tagNodes,function(a){a.hide()})},getTagNodes:function(){return this.tagNodes}});return f},{requires:["overlay"]});KISSY.add("gallery/image-tagging/1.0/index",function(d,p){return p},{requires:["./image-tagging"]});
