KISSY.add("gallery/form/1.2/uploader/auth/base",function(f,d,e){var h="",g=d.all,b=b||f,a="[uploader-auth]:";function c(k,j){var i=this;j=f.merge({uploader:k},j);c.superclass.constructor.call(i,j);i._init()}f.mix(c,{event:{ERROR:"error"}});f.extend(c,e,{_init:function(){var j=this,k=j.get("uploader"),i=k.get("queue");if(k==h){b.log(a+"uploader不可以为空！");return false}j._setSwfButtonExt();i.on("add",function(m){var l=m.file;j.testAllowExt(l);j.testMaxSize(l);j.testRepeat(l)});i.on("remove",function(n){var m=n.file,l=m.status;if(l=="success"){j.testMax()}});i.on("statusChange",function(m){var l=m.status;if(l=="start"&&k.get("disabled")){j._maxStopUpload()}if(l=="success"){j.testMax()}});k.on("error",function(l){k.set("isAllowUpload",true)})},testAll:function(){var i=this;return i.testRequire()&&i.testMax()},getRule:function(j){var i=this,k=i.get("rules");return k[j]},isUploaderType:function(j){var i=this,l=i.get("uploader"),k=l.get("type");return j==k},testRequire:function(){var j=this,o=j.get("uploader"),i=o.get("urlsInput"),n=i.get("urls"),m=j.getRule("require"),l=m?m[0]:false,k=n.length>0;if(!l){return true}if(!k){f.log(a+m[1]);j._fireUploaderError("require",m)}return k},testAllowExt:function(j){if(!f.isObject(j)){return false}var p=this,k=j.name,n=p.getRule("allowExts"),l=[],r,i,q;if(!f.isArray(n)){return false}l=p._getExts(n[0].ext);q=m(k);if(!q){r=o(k);i=f.substitute(n[1],{ext:r});p._fireUploaderError("allowExts",[n[0],i],j)}function m(u){var t=false,s;f.each(l,function(v){s=new RegExp("^.+."+v+"$");if(s.test(u)){return t=true}});return t}function o(t){var s=t.split(".");return s[s.length-1]}return q},testMax:function(){var k=this,o=k.get("uploader"),j=o.get("queue"),l=j.getFiles("success"),i=l.length,n=k.getRule("max"),p;if(n){var m=i<n[0];if(!m){o.set("disabled",true);o.set("isAllowUpload",false);p=f.substitute(n[1],{max:n[0]});k._fireUploaderError("max",[n[0],p])}else{o.set("disabled",false);o.set("isAllowUpload",true)}return m}},testMaxSize:function(k){var i=this,j=k.size,m=i.getRule("maxSize");if(m){var o=Number(m[0])*1024,l=j<=o,n;if(!l){n=f.substitute(m[1],{maxSize:f.convertByteSize(o),size:k.textSize});i._fireUploaderError("maxSize",[m[0],n],k)}return l}},testRepeat:function(k){if(!f.isObject(k)){return false}var q=this,l=k.name,p=q.getRule("allowRepeat");if(p){var j=p[0],m=q.get("uploader"),n=m.get("queue"),i=n.getFiles("success"),o=false;if(j){return false}f.each(i,function(r){if(r.name==l){q._fireUploaderError("allowRepeat",p,k);return o=true}});return o}},_setSwfButtonExt:function(){var j=this,l=j.get("uploader"),i=j.getRule("allowExts"),k=l.get("button"),m=j.isUploaderType("flash");if(!m||!f.isArray(i)){return false}k.set("fileFilters",i[0]);return j},_getExts:function(l){if(!f.isString(l)){return false}var j=l.split(";"),i=[],k=/^\*\./;f.each(j,function(m){m=m.replace(k,"");i.push(m.toUpperCase())});f.each(i,function(m){j.push(m)});return j},_fireUploaderError:function(m,o,l){var j=this,n=j.get("uploader"),i=n.get("queue"),p={status:-1,rule:m},k=-1;if(l){f.mix(p,{file:l});k=i.getFileIndex(p.file.id)}if(o){f.mix(p,{msg:o[1],value:o[0],result:{}})}i.fileStatus(k,"error",p);j.fire(c.event.ERROR,p);n.fire("error",p)},_maxStopUpload:function(){var j=this,m=j.get("uploader"),i=m.get("queue");var k=m.get("curUploadIndex");var l=i.get("files");m.stop();f.each(l,function(o,n){if(n>=k){i.remove(o.id)}})}},{ATTRS:{uploader:{value:h},rules:{value:{allowExts:[{desc:"JPG,JPEG,PNG,GIF,BMP",ext:"*.jpg;*.jpeg;*.png;*.gif;*.bmp"},"不支持{ext}格式的文件上传！"],require:[false,"必须至少上传一个文件！"],max:[3,"每次最多上传{max}个文件！"],maxSize:[1000,"文件大小为{size}，文件太大！"],allowRepeat:[false,"该文件已经存在！"]}}}});return c},{requires:["node","base"]});KISSY.add("gallery/form/1.2/uploader/base",function(g,i,k,m,n,a,l,e,f,d){var b="",h=k.all,j="[uploader]:";function c(p){var o=this;c.superclass.constructor.call(o,p)}g.mix(c,{type:{AUTO:"auto",IFRAME:"iframe",AJAX:"ajax",FLASH:"flash"},event:{RENDER:"render",SELECT:"select",START:"start",PROGRESS:"progress",COMPLETE:"complete",SUCCESS:"success",UPLOAD_FILES:"uploadFiles",CANCEL:"cancel",ERROR:"error",RESTORE:"restore"},status:{WAITING:"waiting",START:"start",PROGRESS:"progress",SUCCESS:"success",CANCEL:"cancel",ERROR:"error",RESTORE:"restore"}});g.extend(c,i,{render:function(){var p=this,u=p.get("serverConfig"),r=p.get("type"),o=p.getUploadType(r),s,t=o.event,q;if(!o){return false}q=p._renderButton();p.set("urlsInput",p._renderUrlsInput());p._renderQueue();if(p.get("type")==c.type.FLASH){g.mix(u,{swfUploader:q.get("swfUploader")})}s=new o(u);s.on(t.SUCCESS,p._uploadCompleteHanlder,p);if(t.PROGRESS){s.on(t.PROGRESS,p._uploadProgressHandler,p)}s.on(t.STOP,p._uploadStopHanlder,p);p.set("uploadType",s);p.fire(c.event.RENDER);return p},upload:function(q){if(!g.isNumber(q)){return false}var p=this,u=p.get("uploadType"),s=p.get("type"),o=p.get("queue"),r=o.get("files")[q],t;if(!g.isPlainObject(r)){g.log(j+"队列中不存在id为"+q+"的文件");return false}if(p.get("curUploadIndex")!=b){alert("第"+p.get("curUploadIndex")+"文件正在上传，请上传完后再操作！");return false}t=r.input.id||r.input;if(s=="ajax"){t=r.data}if(r.status==="error"){return false}p.fire(c.event.START,{index:q,file:r});if(!p.get("isAllowUpload")){return false}p.set("curUploadIndex",q);o.fileStatus(q,c.status.START);u.upload(t)},cancel:function(r){var q=this,t=q.get("uploadType"),o=q.get("queue"),s=c.status,p=o.fileStatus(r);if(g.isNumber(r)&&p!=s.SUCCESS){t.stop();o.fileStatus(r,s.CANCEL)}else{t.stop();q._continueUpload()}return q},stop:function(){var o=this;o.set("uploadFilesStatus",b);o.cancel();return o},uploadFiles:function(o){var p=this;if(!g.isString(o)){o=c.status.WAITING}p.set("uploadFilesStatus",o);p._uploaderStatusFile(o);return p},_uploaderStatusFile:function(q){var r=this,p=r.get("queue"),o=p.getIndexs(q);if(!o.length){r.set("uploadFilesStatus",b);r.fire(c.event.UPLOAD_FILES);return false}r.upload(o[0]);return r},isSupportAjax:function(){var o=false;try{if(FormData){o=true}}catch(p){o=false}return o},isSupportFlash:function(){var o=g.UA.fpv();return g.isArray(o)&&o.length>0},getUploadType:function(r){var p=this,q=c.type,o;if(r==q.AUTO){r=[q.AJAX,q.FLASH,q.IFRAME]}if(g.isArray(r)&&r.length>0){g.each(r,function(s){o=p._getType(s);if(o){return false}})}else{o=p._getType(r)}return o},_getType:function(s){var p=this,r=c.type,o,q=p.isSupportAjax(),t=p.isSupportFlash();switch(s){case r.IFRAME:o=n;break;case r.AJAX:o=q&&a||false;break;case r.FLASH:o=t&&l||false;break;default:g.log(j+"type参数不合法");return false}if(o){g.log(j+"使用"+s+"上传方式")}p.set("type",s);return o},_renderButton:function(){var v=this,r,s,u=v.get("type"),t=v.get("target"),w=v.get("multiple"),q=v.get("disabled"),o=v.get("name"),p={name:o,multiple:w,disabled:q};if(u==c.type.FLASH){s=f;g.mix(p,{size:v.get("swfSize")})}else{s=e}r=new s(t,p);r.on("change",v._select,v);r.render();v.set("button",r);return r},_renderQueue:function(){var q=this,o=new d(),p=q.get("urlsInput");if(!g.isObject(o)){g.log(j+"queue参数不合法");return false}o.set("uploader",q);o.on("remove",function(r){if(r.file.sUrl&&p){p.remove(r.file.sUrl)}});q.set("queue",o);return o},_select:function(s){var p=this,r=p.get("autoUpload"),o=p.get("queue"),t=p.get("curUploadIndex"),q=s.files;g.each(q,function(u){if(!u.size){u.size=0}if(!u.name){u.name=u.fileName||b}u.input=s.input||u});q=p._processExceedMultiple(q);p.fire(c.event.SELECT,{files:q});if(!p.get("isAllowUpload")){return false}o.add(q,function(){if(t==b&&r){p.uploadFiles()}})},_processExceedMultiple:function(q){var p=this,o=p.get("multipleLen");if(o<0||!g.isArray(q)||!q.length){return q}return g.filter(q,function(s,r){return r<o})},_renderUrlsInput:function(){var p=this,r=p.get("button"),s=r.get("target"),q=p.get("urlsInputName"),o=new m(s,{name:q});o.render();return o},_uploadCompleteHanlder:function(u){var r=this,p=u.result,q,t=c.event,o=r.get("queue"),s=r.get("curUploadIndex");if(!g.isObject(p)){return false}o.updateFile(s,{result:p});q=Number(p.status);if(q===1){o.fileStatus(s,c.status.SUCCESS);r._success(p.data);r.fire(t.SUCCESS,{index:s,file:o.getFile(s),result:p})}else{var v=p.msg||p.message||b;o.fileStatus(s,c.status.ERROR,{msg:v,result:p});r.fire(t.ERROR,{status:q,result:p,index:s,file:o.getFile(s)})}r.set("curUploadIndex",b);r.fire(t.COMPLETE,{index:s,file:o.getFile(s),result:p});r._continueUpload()},_uploadStopHanlder:function(){var p=this,o=p.get("queue"),q=p.get("curUploadIndex");o.fileStatus(q,c.status.CANCEL);p.set("curUploadIndex",b);p.fire(c.event.CANCEL,{index:q})},_continueUpload:function(){var o=this,p=o.get("uploadFilesStatus");if(p!=b){o._uploaderStatusFile(p)}},_uploadProgressHandler:function(s){var p=this,o=p.get("queue"),q=p.get("curUploadIndex"),r=o.getFile(q);g.mix(s,{file:r});o.fileStatus(q,c.status.PROGRESS,s);p.fire(c.event.PROGRESS,s)},_success:function(t){if(!g.isObject(t)){return false}var q=this,r=t.url,p=q.get("urlsInput"),s=q.get("curUploadIndex"),o=q.get("queue");if(!g.isString(r)||!g.isObject(p)){return false}o.updateFile(s,{sUrl:r});p.add(r)},restore:function(r){var q=this,o=q.get("queue"),p=q.get("urlsInput");if(!r){r=q._getRestoreData()}if(!r.length){return false}g.each(r,function(u){if(!u.sUrl&&u.result){u.sUrl=u.result.data.url}var t=o.add(u),v=t.id,s=o.getFileIndex(v);p.add(u.sUrl);o.fileStatus(s,"success",{index:s,id:v,file:t})});g.later(function(){q.fire(c.event.RESTORE,{files:o.get("files")})},500)},_getRestoreData:function(){var p=this,q=p.get("restoreHook"),o=h(q);if(!o.length){return[]}return g.JSON.parse(g.trim(o.html()))}},{ATTRS:{button:{value:{}},queue:{value:{}},type:{value:c.type.AUTO},multiple:{value:true,setter:function(p){var o=this,q=o.get("button");if(!g.isEmptyObject(q)&&g.isBoolean(p)){q.set("multiple",p)}return p}},multipleLen:{value:-1},disabled:{value:false,setter:function(p){var o=this,q=o.get("button");if(!g.isEmptyObject(q)&&g.isBoolean(p)){q.set("disabled",p)}return p}},serverConfig:{value:{action:b,data:{},dataType:"json"}},data:{value:{},getter:function(){var o=this,p=o.get("uploadType"),q=o.get("serverConfig").data||{};if(p){q=p.get("data")}return q},setter:function(p){if(g.isObject(p)){var o=this,q=o.get("uploadType");if(q){q.set("data",p);o.set("serverConfig",g.mix(o.get("serverConfig"),{data:p}))}}return p}},isAllowUpload:{value:true},autoUpload:{value:true},urlsInputName:{value:b},curUploadIndex:{value:b},uploadType:{value:{}},urlsInput:{value:b},uploadFilesStatus:{value:b},restoreHook:{value:b},swfSize:{value:{}}}});g.convertByteSize=function(o){var p=-1;do{o=o/1024;p++}while(o>99);return Math.max(o,0.1).toFixed(1)+["kB","MB","GB","TB","PB","EB"][p]};return c},{requires:["base","node","./urlsInput","./type/iframe","./type/ajax","./type/flash","./button/base","./button/swfButton","./queue"]});KISSY.add("gallery/form/1.2/uploader/button/base",function(e,c,d){var g="",b="[Uploader-Button] ",f=c.all;function a(j,i){var h=this;i=e.merge({target:f(j)},i);a.superclass.constructor.call(h,i)}e.mix(a,{event:{beforeShow:"beforeShow",afterShow:"afterShow",beforeHide:"beforeHide",afterHide:"afterHide",beforeRender:"beforeRender",afterRender:"afterRender",CHANGE:"change"},getFileName:function(h){return h.replace(/.*(\/|\\)/,"")}});e.extend(a,d,{render:function(){var h=this,j=h.get("target"),i=h.fire(a.event.beforeRender);if(i===false){e.log(b+"button render was prevented.");return false}else{if(j==null){e.log(b+"Cannot find target!");return false}h._createInput();h.fire(a.event.afterRender);return h}},show:function(){var h=this,i=h.get("target");i.show();h.fire(a.event.afterShow);return a},hide:function(){var h=this,i=h.get("target");i.hide();h.fire(a.event.afterHide);return a},reset:function(){var h=this,i=h.get("inputContainer");f(i).remove();h.set("inputContainer",g);h.set("fileInput",g);h._createInput();return h},_createInput:function(){var h=this,m=h.get("target"),j=h.get("name"),i=h.get("tpl"),k,n,l;if(!e.isString(j)||!e.isString(i)){e.log(b+"No name or tpl specified.");return false}k=e.substitute(i,{name:j});n=f(k);f(n).appendTo(m);l=f(n).children("input");if(e.UA.ie==6){l.css("fontSize","400px")}f(l).on("change",h._changeHandler,h);h.set("fileInput",l);h.set("inputContainer",n);h._setDisabled(h.get("disabled"));h._setMultiple(h.get("multiple"));return n},_changeHandler:function(l){var i=this,k=i.get("fileInput"),m=f(k).val(),h=l.target.files,j=[];if(m==g){e.log(b+"No file selected.");return false}if(h){e.each(h,function(n){if(e.isObject(n)){j.push({name:n.name,type:n.type,size:n.size,data:n})}})}else{j.push({name:a.getFileName(m)})}i.fire(a.event.CHANGE,{files:j,input:k.getDOMNode()});i.reset()},_setDisabled:function(l){var k=this,i=k.get("cls"),m=i.disabled,h=k.get("target"),j=k.get("fileInput");if(!h.length||!e.isBoolean(l)){return false}if(!l){h.removeClass(m);f(j).show()}else{h.addClass(m);f(j).hide()}return l},_setMultiple:function(h){var i=this,j=i.get("fileInput");if(!j.length){return false}h&&j.attr("multiple","multiple")||j.removeAttr("multiple");return h}},{ATTRS:{target:{value:null},fileInput:{value:g},inputContainer:{value:g},tpl:{value:'<div class="file-input-wrapper" style="overflow: hidden;"><input type="file" name="{name}" hidefocus="true" class="file-input" /></div>'},name:{value:"fileInput",setter:function(h){if(this.get("fileInput")){f(this.get("fileInput")).attr("name",h)}return h}},disabled:{value:false,setter:function(h){this._setDisabled(h);return h}},multiple:{value:true,setter:function(h){this._setMultiple(h);return h}},cls:{value:{disabled:"uploader-button-disabled"}}}});return a},{requires:["node","base"]});KISSY.add("gallery/form/1.2/uploader/button/swfButton",function(e,c,d,f){var h="",g=c.all,b="swf-uploader-wrapper-";function a(k,j){var i=this;j=e.merge({target:g(k)},j);a.superclass.constructor.call(i,j)}e.mix(a,{event:{RENDER:"render",CHANGE:"change",MOUSE_OVER:"mouseOver",MOUSE_DOWN:"mouseDown",MOUSE_UP:"mouseUp",MOUSE_OUT:"mouseOut",CLICK:"click"}});e.extend(a,d,{render:function(){var l=this,j=l.get("target"),k,i=l.get("multiple"),m=l.get("fileFilters");j.css("position","relative");l.set("swfWrapper",l._createSwfWrapper());l._setFlashSizeConfig();k=l._initSwfUploader();k.on("contentReady",function(n){k.browse(i,m);l._bindBtnEvent();k.on("fileSelect",l._changeHandler,l);l._setDisabled(l.get("disabled"));l.fire(a.event.RENDER)},l)},_createSwfWrapper:function(){var i=this,l=i.get("target"),j=i.get("tpl"),m=i.get("swfWrapperId")!=h&&i.get("swfWrapperId")||b+e.guid(),k=e.substitute(j,{id:m});i.set("swfWrapperId",m);return g(k).appendTo(l)},_initSwfUploader:function(){var j=this,k=j.get("flash"),m=j.get("swfWrapperId"),i;e.mix(k,{id:"swfUploader"+e.guid()});try{i=new f(m,k);j.set("swfUploader",i)}catch(l){}return i},_bindBtnEvent:function(){var j=this,k=a.event,i=j.get("swfUploader");if(!i){return false}e.each(k,function(l){i.on(l,function(m){j.fire(l)},j)});return j},_setFlashSizeConfig:function(){var i=this,j=i.get("flash"),l=i.get("target"),k=i.get("size");if(!e.isEmptyObject(k)){e.mix(j.attrs,k)}else{e.mix(j.attrs,{width:l.innerWidth(),height:l.innerHeight()})}i.set("flash",j)},_changeHandler:function(k){var i=this,j=k.fileList;i.fire(a.event.CHANGE,{files:j})},_setDisabled:function(n){var l=this,k=l.get("swfUploader"),j=l.get("cls"),o=j.disabled,i=l.get("target"),m=l.get("swfWrapper");if(!k||!e.isBoolean(n)){return false}if(!n){i.removeClass(o);m.css("top",0)}else{i.addClass(o);m.css("top","-3000px")}return n},show:function(){var j=this,i=j.get("target");i.show()},hide:function(){var j=this,i=j.get("target");i.hide()}},{ATTRS:{target:{value:h},swfWrapper:{value:h},swfWrapperId:{value:h},tpl:{value:'<div id="{id}" class="uploader-button-swf" style="position: absolute;top:0;left:0;z-index:2000;"></div>'},multiple:{value:true,setter:function(k){var j=this,i=j.get("swfUploader");if(i){i.multifile(k)}return k}},fileFilters:{value:[],setter:function(k){var j=this,i=j.get("swfUploader");if(e.isObject(k)){k=[k]}if(i&&e.isArray(k)){e.later(function(){i.filter(k)},800)}return k}},disabled:{value:false,setter:function(k){var j=this,i=j.get("swfUploader");if(i){j._setDisabled(k)}return k}},cls:{value:{disabled:"uploader-button-disabled"}},size:{value:{}},flash:{value:{src:"http://a.tbcdn.cn/s/kissy/gallery/form/1.2/uploader/plugins/ajbridge/uploader.swf",id:"swfUploader",params:{bgcolor:"#fff",wmode:"transparent"},attrs:{},hand:true,btn:true}},swfUploader:{value:h}}});return a},{requires:["node","base","../plugins/ajbridge/uploader"]});KISSY.add("gallery/form/1.2/uploader/index",function(e,g,i,d,j){var c="",f=i.all,h="[uploaderRender]:",a={CONFIG:"data-config",BUTTON_CONFIG:"data-button-config",THEME_CONFIG:"data-theme-config",AUTH:"data-auth"},k=["default","imageUploader","ershouUploader","uploadify"],l="gallery/form/1.2/uploader/themes/";e.namespace("form");e.form.parseConfig=function(r,m){var n={},q,o=m||a.CONFIG;q=f(r).attr(o);if(!e.isString(q)){return{}}try{n=e.JSON.parse(q)}catch(p){e.log(h+"请检查"+r+"上"+o+"属性内的json格式是否符合规范！")}return n};function b(p,m,o){var n=this;o=e.mix(e.form.parseConfig(p),o);b.superclass.constructor.call(n,o);n.set("buttonTarget",p);n.set("queueTarget",m);n.set("uploaderConfig",o);n._init()}e.extend(b,g,{_init:function(){var m=this,o=m.get("theme"),n;if(o==c){n=m._initUploader();m.set("button",n.get("button"));e.later(function(){m.fire("init",{uploader:n,button:n.get("button"),queue:n.get("queue"),auth:n.get("auth")})},500)}else{m._initThemes(function(p){n=m._initUploader();m.set("button",n.get("button"));p.set("uploader",n);p.set("button",n.get("button"));p.set("queue",n.get("queue"));p.set("auth",n.get("auth"));p._UploaderRender(function(){p.afterUploaderRender(n);n.restore();m.fire("init",{uploader:n,button:n.get("button"),queue:n.get("queue"),auth:n.get("auth")})})})}},_initUploader:function(){var m=this,o=m.get("uploaderConfig"),n=m.get("name");e.mix(o.serverConfig,{fileDataName:n});e.mix(o,{target:m.get("buttonTarget")});var p=new d(o);p.render();m.set("uploader",p);m._auth();return p},_initThemes:function(r){var m=this,q=m.get("theme"),p=m.get("buttonTarget"),o=m.get("themeConfig"),n=e.form.parseConfig(p,a.THEME_CONFIG);e.mix(n,o);m.set("themeConfig",n);q=m._getThemeName(q);e.use(q,function(u,t){var s=m.get("queueTarget"),v;u.mix(n,{queueTarget:s,buttonTarget:m.get("buttonTarget")});v=new t(n);v.on("render",function(){r&&r.call(m,v)});v.render()})},_getThemeName:function(n){var m=n;e.each(k,function(o){if(o==n){m=l+n}});m=m+"/index";return m},_auth:function(){var m=this,o=m.get("buttonTarget"),q=m.get("uploader"),p=m.get("authConfig"),n=e.form.parseConfig(o,a.AUTH);e.mix(n,p);m.set("authConfig",n);if(e.isEmptyObject(n)){return false}auth=new j(q,{rules:n});q.set("auth",auth);return auth}},{ATTRS:{theme:{value:"default"},themeConfig:{value:{}},buttonTarget:{value:c},queueTarget:{value:c},uploaderConfig:{},authConfig:{value:{}},button:{value:c},queue:{value:c},uploader:{value:c}}});return b},{requires:["base","node","./base","./auth/base"]});KISSY.add("gallery/form/1.2/uploader/plugins/ajbridge/ajbridge",function(b,h){var a="#",g="1.0.15",f="ks-ajb-",c=100,e="KISSY.AJBridge.eventHandler";function d(n,j,k){n=n.replace(a,"");j=h._normalize(j||{});var i=this,l=a+n,m=function(o){if(o.status<1){i.fire("failed",{data:o});return}b.mix(i,o);if(!o.dynamic||!j.src){i.activate()}};j.id=j.id||b.guid(f);d.instances[j.id]=i;if(j.src){j.params.allowscriptaccess="always";j.params.flashvars=b.merge(j.params.flashvars,{jsEntry:e,swfID:j.id})}if(k){i.__args=[l,j,m]}else{b.later(h.add,c,false,h,[l,j,m])}}b.mix(d,{version:g,instances:{},eventHandler:function(k,j){var i=d.instances[k];if(i){i.__eventHandler(k,j)}},augment:function(j,i){if(b.isString(i)){i=[i]}if(!b.isArray(i)){return}b.each(i,function(k){j.prototype[k]=function(){try{return this.callSWF(k,b.makeArray(arguments))}catch(l){this.fire("error",{message:l})}}})}});b.augment(d,b.EventTarget,{init:function(){if(!this.__args){return}h.add.apply(h,this.__args);this.__args=null;delete this.__args},__eventHandler:function(l,k){var i=this,j=k.type;k.id=l;switch(j){case"log":b.log(k.message);break;default:i.fire(j,k)}},callSWF:function(k,j){var i=this;j=j||[];try{if(i.swf[k]){return i.swf[k].apply(i.swf,j)}}catch(l){var m="";if(j.length!==0){m="'"+j.join("','")+"'"}return(new Function("self","return self.swf."+k+"("+m+");"))(i)}}});d.augment(d,["activate","getReady","getCoreVersion"]);window.AJBridge=b.AJBridge=d;return d},{requires:["flash"]});KISSY.add("gallery/form/1.2/uploader/plugins/ajbridge/uploader",function(c,b,a){function d(g,f){f=f||{};var e={};c.each(["ds","dsp","btn","hand"],function(h){if(h in f){e[h]=f[h]}});f.params=f.params||{};f.params.flashvars=c.merge(f.params.flashvars,e);d.superclass.constructor.call(this,g,f)}c.extend(d,a);a.augment(d,["setFileFilters","filter","setAllowMultipleFiles","multifile","browse","upload","uploadAll","cancel","getFile","removeFile","lock","unlock","setBtnMode","useHand","clear"]);d.version="1.0.1";a.Uploader=d;return a.Uploader},{requires:["flash","./ajbridge"]});KISSY.add("gallery/form/1.2/uploader/plugins/filedrop/filedrop",function(d,b,c){var g="",f=b.all,e=d.UA;var h=function(j){var i=this;h.superclass.constructor.call(i,j);i.set("mode",a())};var a=function(){if(e.webkit>=7||e.firefox>=3.6){return"supportDrop"}if(e.ie){return"notSupportDropIe"}if(e.webkit<7||e.firefox<3.6){return"notSupportDrop"}};d.mix(h,{event:{AFTER_DROP:"afterdrop"}});d.extend(h,c,{render:function(){var j=this,l=j.get("mode"),k=j.get("uploader"),i;if(k.get("type")=="flash"){d.log("flash上传方式不支持拖拽！");j.set("isSupport",false);return false}if(l!="supportDrop"){d.log("该浏览器不支持拖拽上传！");j.set("isSupport",false);return false}if(!k){d.log("缺少Uploader的实例！");return false}i=j._createDropArea();if(i.length){i.on("click",j._clickHandler,j)}k.on("afterDisabledChange",function(m){j[m.newVal&&"hide"||"show"]()});j.fire("afterRender",{buttonTarget:j.get("buttonWrap")})},show:function(){var i=this,j=i.get("dropContainer");j.show()},hide:function(){var i=this,j=i.get("dropContainer");j.hide()},reset:function(){},_createDropArea:function(){var j=this,l=f(j.get("target")),n=j.get("mode"),k=d.substitute(j.get("tpl")[n],{name:j.get("name")}),m=f(k),i=m.all(".J_ButtonWrap");m.appendTo(l);m.on("dragover",function(o){o.stopPropagation();o.preventDefault()});m.on("drop",function(o){o.stopPropagation();o.preventDefault();j._dropHandler(o)});j.set("dropContainer",m);j.set("buttonWrap",i);j._setStyle();return m},_setStyle:function(){var i=this,j=i.get("dropContainer");if(!j.length){return false}j.parent().css("position","relative");j.css({position:"absolute",top:"0",left:"0",width:"100%",height:"100%",zIndex:"1000"})},_clickHandler:function(l){var j=this,i=f(l.target),m=j.get("uploader"),k=m.get("button"),n=k.get("fileInput");n.fire("click")},_dropHandler:function(m){var i=this,l=h.event,j=m.originalEvent.dataTransfer.files,k=[],n=i.get("uploader");if(!j.length||n==g){return false}d.each(j,function(o){if(d.isObject(o)){k.push({name:o.name,type:o.type,size:o.size,data:o})}});i.fire(l.AFTER_DROP,{files:k});n._select({files:k})},_setDisabled:function(){}},{ATTRS:{target:{value:g},uploader:{value:g},dropContainer:{value:g},isSupport:{value:true},tpl:{value:{supportDrop:'<div class="drop-wrapper"><p>直接拖拽图片到这里，</p><p class="J_ButtonWrap">或者</p></div>',notSupportDropIe:'<div class="drop-wrapper"><p>您的浏览器只支持传统的图片上传，</p><p class="suggest J_ButtonWrap">推荐使用chrome浏览器或firefox浏览器</p></div>',notSupportDrop:'<div class="drop-wrapper"><p>您的浏览器只支持传统的图片上传，</p><p class="suggest J_ButtonWrap">推荐升级您的浏览器</p></div>'}},name:{value:"",setter:function(i){}},disabled:{value:false,setter:function(i){this._setDisabled(i);return i}},cls:{disabled:"drop-area-disabled"}}});return h},{requires:["node","base"]});KISSY.add("gallery/form/1.2/uploader/plugins/preview/preview",function(e,a,i){var h=document,d="[Plugin: Preview] ",b=f(),j={check:"check",success:"success",showed:"showed",error:"error"},k=e.UA.ie<8?"http://a.tbcdn.cn/p/fp/2011a/assets/space.gif":"data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";function f(){var l="";if(typeof window.FileReader==="undefined"){switch(e.UA.shell){case"firefox":l="domfile";break;case"ie":switch(e.UA.ie){case 6:l="simple";break;default:l="filter";break}break}}else{l="html5"}return l}function g(o,n,m,l){if(!o){return false}if(b!="filter"){o.src=n||k}else{o.src=k;if(n){n=n.replace(/[)'"%]/g,function(p){return escape(escape(p))});o.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='scale',src='"+n+"')";o.zoom=1}}return true}function c(m){var l=this,n={maxWidth:40,maxHeight:40};l.config=e.mix(n,m);e.log(d+"Preview initialized. The preview mode is "+b)}e.augment(c,e.EventTarget,{preview:function(o,p){o=a.get(o);p=a.get(p);var n=this,m=function(){n.fire(j.getData,{data:n.data,mode:b});if(p){g(p,n.data);n.fire(j.showed,{img:p})}};n.data=undefined;if(o){e.log(d+"One file selected. Getting data...");switch(b){case"domfile":n.data=o.files[0].getAsDataURL();break;case"filter":o.select();try{n.data=h.selection.createRange().text}catch(q){e.log(d+"Get image data error, the error is: ");e.log(q,"dir")}finally{h.selection.empty()}if(!n.data){n.data=o.value}break;case"html5":var l=new FileReader();l.onload=function(r){n.data=r.target.result;m()};l.onerror=function(r){e.log(d+"File Reader Error. Your browser may not fully support html5 file api","warning");n.fire(j.error)};if(o.files){l.readAsDataURL(o.files[0])}break;case"simple":default:n.data=o.value;break}if(n.data){m()}else{if(b!="html5"){e.log(d+"Retrive Data error.");g(p);n.fire(j.error)}}}else{e.log(d+"File Input Element does not exists.")}return n.data}});return c},{requires:["dom","event"]});KISSY.add("gallery/form/1.2/uploader/plugins/progressBar/progressBar",function(d,g,f){var a="",e=g.all,i="progressbar",b="role",h="aria-valuemin",l="aria-valuemax",c="aria-valuenow",j="data-value";function k(o,n){var m=this;n=d.merge({wrapper:e(o)},n);k.superclass.constructor.call(m,n)}d.mix(k,{tpl:{DEFAULT:'<div class="ks-progress-bar-value" data-value="{value}"></div>'},cls:{PROGRESS_BAR:"ks-progress-bar",VALUE:"ks-progress-bar-value"},event:{RENDER:"render",CHANGE:"change",SHOW:"show",HIDE:"hide"}});d.extend(k,f,{render:function(){var m=this,o=m.get("wrapper"),n=m.get("width");if(!o.length){return false}o.addClass(k.cls.PROGRESS_BAR).width(n);m._addAttr();!m.get("visible")&&m.hide();m.set("bar",m._create());m.fire(k.event.RENDER)},show:function(){var m=this,n=m.get("wrapper");n.fadeIn(m.get("duration"),function(){m.set("visible",true);m.fire(k.event.SHOW,{visible:true})})},hide:function(){var m=this,n=m.get("wrapper");n.fadeOut(m.get("duration"),function(){m.set("visible",false);m.fire(k.event.HIDE,{visible:false})})},_create:function(){var m=this,q=m.get("wrapper"),p=m.get("value"),n=m.get("tpl"),o=d.substitute(n,{value:p});q.html("");return e(o).appendTo(q)},_addAttr:function(){var m=this,o=m.get("wrapper"),n=m.get("value");o.attr(b,i);o.attr(h,0);o.attr(l,100);o.attr(c,n);return m}},{ATTRS:{wrapper:{value:a},bar:{value:a},width:{value:100},value:{value:0,setter:function(n){var m=this,q=m.get("wrapper"),r=m.get("bar"),p=m.get("speed"),o;if(n>100){n=100}if(n<0){n=0}o=q.width()*(n/100);r.animate({width:o+"px"},p,"none",function(){q.attr(c,n);r.attr(j,n);m.fire(k.event.CHANGE,{value:n,width:o})});return n}},visible:{value:true},duration:{value:0.3},tpl:{value:k.tpl.DEFAULT},speed:{value:0.2}}});return k},{requires:["node","base"]});KISSY.add("gallery/form/1.2/uploader/queue",function(d,b,c){var g="",f=b.all,a="[uploader-queue]:";function e(i){var h=this;e.superclass.constructor.call(h,i)}d.mix(e,{tpl:{DEFAULT:'<li id="queue-file-{id}" class="clearfix" data-name="{name}"><div class="f-l sprite file-icon"></div><div class="f-l">{name}</div><div class="f-l file-status J_FileStatus"></div></li>'},event:{ADD:"add",ADD_FILES:"addFiles",REMOVE:"remove",CLEAR:"clear",FILE_STATUS:"statusChange",UPDATE_FILE:"updateFile",RESTORE:"restore"},status:{WAITING:"waiting",START:"start",PROGRESS:"progress",SUCCESS:"success",CANCEL:"cancel",ERROR:"error",RESTORE:"restore"},cls:{QUEUE:"ks-uploader-queue"},hook:{STATUS:".J_FileStatus"},FILE_ID_PREFIX:"file-"});d.extend(e,c,{add:function(j,k){var h=this,i={};if(j.length>0){i=[];d.each(j,function(l){i.push(h._addFile(l))})}else{i=h._addFile(j)}k&&k.call(h);return i},_addFile:function(l,m){if(!d.isObject(l)){d.log(a+"_addFile()参数file不合法！");return false}var i=this,k=i._setAddFileData(l),j=i.getFileIndex(k.id),h=i.get("fnAdd");if(d.isFunction(h)){k=h(j,k)}i.fire(e.event.ADD,{index:j,file:k,uploader:i.get("uploader")});m&&m.call(i,j,k);return k},remove:function(i,l){var h=this,k=h.get("files"),j;if(d.isString(i)){i=h.getFileIndex(i)}j=k[i];if(!d.isObject(j)){d.log(a+"remove()不存在index为"+i+"的文件数据");return false}k=d.filter(k,function(n,m){return m!==i});h.set("files",k);h.fire(e.event.REMOVE,{index:i,file:j});l&&l.call(h,i,j);return j},clear:function(){var h=this,j;i();function i(){j=h.get("files");if(!j.length){h.fire(e.event.CLEAR);return false}h.remove(0,function(){i()})}},fileStatus:function(l,i,k){if(!d.isNumber(l)){return false}var j=this,n=j.getFile(l),o=j.get("theme"),h,m;if(!n){return false}h=n.status;if(!i){return h}if(h==i){return j}j.updateFile(l,{status:i});m="_"+i+"Handler";if(o&&d.isFunction(o[m])){k=d.merge({uploader:j.get("uploader"),index:l,file:n,id:n.id},k);o[m].call(o,k)}j.fire(e.event.FILE_STATUS,{index:l,status:i,args:k,file:n});return j},getFile:function(i){if(!d.isNumber(i)){return false}var h=this,k=h.get("files"),j=k[i];if(!d.isPlainObject(j)){d.log("getFile():文件数据为空！");j={}}return j},getFileIndex:function(h){var i=this,k=i.get("files"),j=-1;d.each(k,function(m,l){if(m.id==h){j=l;return true}});return j},updateFile:function(i,l){if(!d.isNumber(i)){return false}if(!d.isObject(l)){d.log(a+"updateFile()的data参数有误！");return false}var h=this,k=h.get("files"),j=h.getFile(i);if(!j){return false}d.mix(j,l);k[i]=j;h.set("files",k);h.fire(e.event.UPDATE_FILE,{index:i,file:j});return j},getIndexs:function(j){var i=this,k=i.get("files"),h,l=[];if(!k.length){return l}d.each(k,function(n,m){if(d.isObject(n)){h=n.status;if(h==j){l.push(m)}}});return l},getFiles:function(h){var i=this,k=i.get("files"),j=[];if(!k.length){return[]}d.each(k,function(l){if(l&&l.status==h){j.push(l)}});return j},_setAddFileData:function(i){var h=this,j=h.get("files");if(!d.isObject(i)){d.log(a+"_updateFileData()参数file不合法！");return false}if(!i.id){i.id=d.guid(e.FILE_ID_PREFIX)}if(i.size){i.textSize=d.convertByteSize(i.size)}i.status=g;j.push(i);return i}},{ATTRS:{fnAdd:{value:g},files:{value:[]},uploader:{value:g},theme:{value:g}}});return e},{requires:["node","base"]});KISSY.add("gallery/form/1.2/uploader/theme",function(e,c,d){var g="",f=c.all,a={BUTTON:"-button",QUEUE:"-queue"};function b(i){var h=this;b.superclass.constructor.call(h,i)}e.extend(b,d,{render:function(){var h=this;h._LoaderCss(function(){h._addThemeCssName();h.fire("render")})},afterUploaderRender:function(h){},_getStatusWrapper:function(h){return h&&h.children(".J_FileStatus")||f("")},displayFile:function(i,k,l){var h=this,j=h.get("duration");if(!k||!k.length){return false}k[i&&"fadeIn"||"fadeOut"](j,function(){l&&l.call(h)})},_waitingHandler:function(h){},_startHandler:function(h){},_progressHandler:function(h){},_successHandler:function(h){},_errorHandler:function(h){},_restoreHandler:function(h){},_UploaderRender:function(i){var h=this;h._initQueue();h._loadPlugins(i)},_addThemeCssName:function(){var h=this,i=h.get("name"),k=f(h.get("queueTarget")),j=f(h.get("buttonTarget"));if(i==g){return false}if(k.length){k.addClass(i+a.QUEUE)}j.addClass(i+a.BUTTON)},_initQueue:function(){var i=this,h=i.get("queue");h.set("fnAdd",function(j,k){return i._addCallback(j,k)});h.set("theme",i);h.on("add",i._addFileHandler,i);h.on("remove",i._removeFileHandler,i);h.on("statusChange",function(j){i._setStatusVisibility(j)});return h},_LoaderCss:function(j){var h=this,i=h.get("cssUrl");if(i==g){j.call(h);return false}e.use(i,function(){e.log(i+"加载成功！");j.call(h)})},_addCallback:function(k,l){var j=this,i=j.get("queue"),h=j._appendFileDom(l);i.updateFile(k,{target:h,statusWrapper:j._getStatusWrapper(h)});i.fileStatus(k,"waiting");j.displayFile(true,h);j._bindTriggerEvent(k,l);return i.getFile(k)},_removeFileHandler:function(j){var h=this,i=j.file;h.displayFile(false,i.target)},_bindTriggerEvent:function(o,i){var p=this,m=p.get("queue"),l=p.get("uploader"),h=i.id,n=f(".J_Upload_"+h),k=f(".J_Cancel_"+h),j=f(".J_Del_"+h);n.on("click",function(q){q.preventDefault();if(!e.isObject(l)){return false}l.upload(o)});k.on("click",function(q){q.preventDefault();l.cancel(o)});j.on("click",function(q){q.preventDefault();m.remove(h)})},_setStatusVisibility:function(k){var l=k.file.statusWrapper,j,i=k.file,h=i.status;if(!l||!l.length){e.log("状态容器层不存在！");return false}j=l.children(".status");j.hide();l.children("."+h+"-status").show()},_appendFileDom:function(k){var i=this,j=i.get("fileTpl"),h=f(i.get("queueTarget")),l;if(!h.length){return false}l=e.substitute(j,k);return f(l).hide().appendTo(h).data("data-file",k)},_loadPlugins:function(m){var i=this,h=i.get("plugins"),l=i.get("oPlugin"),k="gallery/form/1.2/uploader/plugins/",j=[];if(!h.length){m&&m.call(i,l);return false}e.each(h,function(n){j.push(k+n+"/"+n)});e.use(j.join(","),function(){e.each(arguments,function(n,o){if(o>=1){l[h[o-1]]=n}});i.set("oPlugin",l);m&&m.call(i,l)})}},{ATTRS:{name:{value:g},cssUrl:{value:g},fileTpl:{value:g},plugins:{value:[]},oPlugin:{value:{}},queueTarget:{value:g},duration:{value:0.3},queue:{value:g},uploader:{value:g},button:{value:g},auth:{value:g}}});return b},{requires:["node","base"]});KISSY.add("gallery/form/1.2/uploader/type/ajax",function(d,c,b){var f="",e=c.all,a="[uploader-AjaxType]:";function g(i){var h=this;g.superclass.constructor.call(h,i)}d.mix(g,{event:d.merge(b.event,{PROGRESS:"progress"})});d.extend(g,b,{upload:function(i){if(!i){d.log(a+"upload()，fileData参数有误！");return false}var h=this;h._setFormData();h._addFileData(i);h.send();return h},stop:function(){var h=this,i=h.get("xhr");if(!d.isObject(i)){d.log(a+"stop()，io值错误！");return false}i.abort();h.fire(g.event.STOP);return h},send:function(){var h=this,j=h.get("action"),i=h.get("formData");var k=new XMLHttpRequest();k.upload.addEventListener("progress",function(l){h.fire(g.event.PROGRESS,{loaded:l.loaded,total:l.total})});k.onload=function(m){var l={};try{l=d.JSON.parse(k.responseText)}catch(n){d.log(a+"ajax返回结果集responseText格式不合法！")}h.fire(g.event.SUCCESS,{result:l})};k.open("POST",j,true);i.append("type","ajax");k.send(i);h._setFormData();h.set("xhr",k);return h},_setFormData:function(){var h=this;try{h.set("formData",new FormData());h._processData()}catch(i){d.log(a+"something error when reset FormData.");d.log(i,"dir")}},_processData:function(){var h=this,i=h.get("data"),j=h.get("formData");d.each(i,function(l,k){j.append(k,l)});h.set("formData",j)},_addFileData:function(i){if(!d.isObject(i)){d.log(a+"_addFileData()，file参数有误！");return false}var h=this,j=h.get("formData"),k=h.get("fileDataName");j.append(k,i);h.set("formData",j)}},{ATTRS:{formData:{value:f},ajaxConfig:{value:{type:"post",processData:false,cache:false,dataType:"json",contentType:false}},xhr:{value:f},fileDataName:{value:f},form:{value:{}},fileInput:{value:f}}});return g},{requires:["node","./base"]});KISSY.add("gallery/form/1.2/uploader/type/base",function(d,b,c){var f="",e=b.all;function a(h){var g=this;a.superclass.constructor.call(g,h)}d.mix(a,{event:{START:"start",STOP:"stop",SUCCESS:"success",ERROR:"error"}});d.extend(a,c,{upload:function(){},stop:function(){}},{ATTRS:{action:{value:f},data:{value:{}}}});return a},{requires:["node","base"]});KISSY.add("gallery/form/1.2/uploader/type/flash",function(e,d,c,a){var h="",g=d.all,b="[uploader-FlashType]:";function f(j){var i=this;f.superclass.constructor.call(i,j);i.isHasCrossdomain();i._init()}e.mix(f,{event:e.merge(c.event,{SWF_READY:"swfReady",PROGRESS:"progress"})});e.extend(f,c,{_init:function(){var j=this,i=j.get("swfUploader");if(!i){e.log(b+"swfUploader对象为空！");return false}i.on("contentReady",function(k){j.fire(f.event.SWF_READY)},j);i.on("uploadStart",j._uploadStartHandler,j);i.on("uploadProgress",j._uploadProgressHandler,j);i.on("uploadCompleteData",j._uploadCompleteDataHandler,j);i.on("uploadError",j._uploadErrorHandler,j)},upload:function(o){var j=this,i=j.get("swfUploader"),m=j.get("action"),n="POST",l=j.get("data"),k=j.get("fileDataName");if(!k){k="Filedata"}j.set("uploadingId",o);e.mix(l,{type:"flash"});i.upload(o,m,n,l,k);return j},stop:function(){var k=this,j=k.get("swfUploader"),i=k.get("uploadingId");if(i!=h){j.cancel(i);k.fire(f.event.STOP,{id:i})}return k},_uploadStartHandler:function(j){var i=this;i.fire(f.event.START,{file:j.file})},_uploadProgressHandler:function(j){var i=this;e.mix(j,{loaded:j.bytesLoaded,total:j.bytesTotal});e.log(b+"已经上传字节数为："+j.bytesLoaded);i.fire(f.event.PROGRESS,{loaded:j.loaded,total:j.total})},_uploadCompleteDataHandler:function(l){var j=this,i;try{i=JSON.parse(l.data)}catch(k){e.log(b+"json数据格式不合法！");j.fire(f.event.ERROR,{msg:"不是合法的json数据"})}e.log(b+"服务器端输出："+i);j.set("uploadingId",h);j.fire(f.event.SUCCESS,{result:i})},_uploadErrorHandler:function(j){var i=this;i.set("uploadingId",h);i.fire(f.event.ERROR,{msg:j.msg})},isHasCrossdomain:function(){var i=location.hostname;e.io({url:"http://"+i+"/crossdomain.xml",dataType:"xml",error:function(){e.log("缺少crossdomain.xml文件或该文件不合法！")}})}},{ATTRS:{action:{value:h,getter:function(l){var m=/^http/;if(!m.test(l)){var k=location.href,j=k.split("/"),i;i=e.filter(j,function(o,n){return n<j.length-1});l=i.join("/")+"/"+l}return l}},swfUploader:{value:h},uploadingId:{value:h}}});return f},{requires:["node","./base"]});KISSY.add("gallery/form/1.2/uploader/type/iframe",function(e,d,c){var h="",g=d.all,b="[uploader-iframeType]:",a="ks-uploader-iframe-";function f(j){var i=this;f.superclass.constructor.call(i,j)}e.mix(f,{tpl:{IFRAME:'<iframe src="javascript:false;" name="{id}" id="{id}" border="no" width="1" height="1" style="display: none;" />',FORM:'<form method="post" enctype="multipart/form-data" action="{action}" target="{target}" style="visibility: hidden;">{hiddenInputs}</form>',HIDDEN_INPUT:'<input type="hidden" name="{name}" value="{value}" />'},event:e.mix(c.event,{CREATE:"create",REMOVE:"remove"})});e.extend(f,c,{upload:function(k){var i=this,l=g(k),j;if(!l.length){return false}i.fire(f.event.START,{input:l});i.set("fileInput",l);i._create();j=i.get("form");if(!j){e.log(b+"form节点不存在！");return false}j.getDOMNode().submit()},stop:function(){var i=this,j=i.get("iframe");j.attr("src",'javascript:"<html></html>";');i._remove();i.fire(f.event.STOP);i.fire(f.event.ERROR,{status:"abort",msg:"上传失败，原因：abort"});return i},dataToHidden:function(n){if(!e.isObject(n)||e.isEmptyObject(n)){return""}var l=this,j=h,m=l.get("tpl"),o=m.HIDDEN_INPUT;if(!e.isString(o)){return""}for(var i in n){j+=e.substitute(o,{name:i,value:n[i]})}return j},_createIframe:function(){var j=this,o=a+e.guid(),k=j.get("tpl"),l=k.IFRAME,i=j.get("iframe"),m,n;if(!e.isEmptyObject(i)){return i}if(!e.isString(l)){e.log(b+"iframe的模板不合法！");return false}if(!e.isString(o)){e.log(b+"id必须存在且为字符串类型！");return false}m=e.substitute(k.IFRAME,{id:o});n=g(m);n.on("load",j._iframeLoadHandler,j);g("body").append(n);j.set("id",o);j.set("iframe",n);return n},_iframeLoadHandler:function(m){var j=this,k=m.target,o=f.event.ERROR,n=k.contentDocument||window.frames[k.id].document,i;if(!n||!n.body){j.fire(o,{msg:"服务器端返回数据有问题！"});return false}i=n.body.innerHTML;e.log(b+"服务器端输出:"+i);if(i==h){return false}try{i=JSON.parse(i)}catch(l){e.log(b+"json数据格式不合法！");j.fire(o,{msg:"数据："+i+"不是合法的json数据"})}j.fire(f.event.SUCCESS,{result:i});j._remove()},_createForm:function(){var q=this,j=q.get("id"),o=q.get("tpl"),p=o.FORM,l=q.get("data"),k=q.get("action"),m=q.get("fileInput"),n,r,i;if(!e.isString(p)){e.log(b+"form模板不合法！");return false}if(!e.isString(k)){e.log(b+"action参数不合法！");return false}n=q.dataToHidden(l);n+=q.dataToHidden({type:"iframe"});i=e.substitute(p,{action:k,target:j,hiddenInputs:n});r=g(i).append(m);g("body").append(r);q.set("form",r);return r},_create:function(){var i=this,j=i._createIframe(),k=i._createForm();i.fire(f.event.CREATE,{iframe:j,form:k})},_remove:function(){var i=this,j=i.get("form");if(!j){e.log(b+"form节点不存在！");return false}j.remove();i.reset("form");i.fire(f.event.REMOVE,{form:j})}},{ATTRS:{tpl:{value:f.tpl},id:{value:a+e.guid()},iframe:{value:{}},form:{value:{}},fileInput:{value:h}}});return f},{requires:["node","./base"]});KISSY.add("gallery/form/1.2/uploader/urlsInput",function(e,c,d){var g="",f=c.all,b="[uploader-urlsInput]:";function a(j,i){var h=this;a.superclass.constructor.call(h,i);h.set("wrapper",f(j))}e.mix(a,{TPL:'<input type="hidden" id="{name}" name="{name}" value="{value}" />'});e.extend(a,d,{render:function(){var i=this,k=i.get("wrapper"),j=i.get("name"),h=document.getElementsByName(j)[0];if(!e.isObject(k)){e.log(b+"container参数不合法！");return false}if(h){e.log(b+"urls input found");i.set("input",f(h))}else{i._create()}return i},add:function(i){if(!e.isString(i)){e.log(b+"add()的url参数不合法！");return false}var h=this,k=h.get("urls"),j=h.isExist(i);if(k[0]==g){k=[]}if(j){e.log(b+"add()，文件路径已经存在！");return h}k.push(i);h.set("urls",k);h._val();return h},remove:function(i){if(!i){return false}var h=this,l=h.get("urls"),k=h.isExist(i),j=new RegExp(i);if(!k){e.log(b+"remove()，不存在该文件路径！");return false}l=e.filter(l,function(m){return !j.test(m)});h.set("urls",l);h._val();return l},parse:function(){var i=this,h=i.get("input");if(h){var l=f(h).val(),j=i.get("split"),k;k=l.split(j);i.set("urls",k);return k}else{e.log(b+"cannot find urls input.");return[]}},_val:function(){var h=this,k=h.get("urls"),l=h.get("input"),i=h.get("split"),j=k.join(i);l.val(j);return j},isExist:function(j){var i=this,h=false,l=i.get("urls"),k=new RegExp(j);if(!l.length){return false}e.each(l,function(m){if(k.test(m)){return h=true}});return h},_create:function(){var j=this,h=j.get("wrapper"),l=j.get("tpl"),k=j.get("name"),m=j.get("urls"),i;if(!h||h.length<=0){e.log(b+"UrlsInput container not specified!","warn");return false}if(!e.isString(l)||!e.isString("name")){e.log(b+"_create()，tpl和name属性不合法！");return false}i=f(e.substitute(l,{name:k,value:m}));h.append(i);j.set("input",i);e.log(b+"input created.");return i}},{ATTRS:{name:{value:g},urls:{value:[]},tpl:{value:a.TPL},split:{value:",",setter:function(i){var h=this;h._val();return i}},input:{value:g},wrapper:{value:g}}});return a},{requires:["node","base"]});